<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>WeBWorKChemistry: Chemical::LewisStructure Class Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">WeBWorKChemistry
   &#160;<span id="projectnumber">0.90</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',false,false,'search.php','Search');
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('classChemical_1_1LewisStructure.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<div class="header">
  <div class="summary">
<a href="#pub-methods">Public Member Functions</a> &#124;
<a href="#pub-static-attribs">Static Public Attributes</a> &#124;
<a href="classChemical_1_1LewisStructure-members.html">List of all members</a>  </div>
  <div class="headertitle">
<div class="title">Chemical::LewisStructure Class Reference</div>  </div>
</div><!--header-->
<div class="contents">
<div id="dynsection-0" onclick="return toggleVisibility(this)" class="dynheader closed" style="cursor:pointer;">
  <img id="dynsection-0-trigger" src="closed.png" alt="+"/> Collaboration diagram for Chemical::LewisStructure:</div>
<div id="dynsection-0-summary" class="dynsummary" style="display:block;">
</div>
<div id="dynsection-0-content" class="dyncontent" style="display:none;">
<div class="center"><img src="classChemical_1_1LewisStructure__coll__graph.png" border="0" usemap="#Chemical_1_1LewisStructure_coll__map" alt="Collaboration graph"/></div>
<map name="Chemical_1_1LewisStructure_coll__map" id="Chemical_1_1LewisStructure_coll__map">
<area shape="rect" title=" " alt="" coords="5,95,192,121"/>
<area shape="rect" title=" " alt="" coords="52,5,145,32"/>
</map>
<center><span class="legend">[<a target="top" href="graph_legend.html">legend</a>]</span></center></div>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="pub-methods"></a>
Public Member Functions</h2></td></tr>
<tr class="memitem:a6a5c508d640cb21907bfe2e0064b95be"><td class="memItemLeft" align="right" valign="top">public method&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classChemical_1_1LewisStructure.html#a6a5c508d640cb21907bfe2e0064b95be">compareKekuleCTABAndHash</a> ()</td></tr>
<tr class="separator:a6a5c508d640cb21907bfe2e0064b95be"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a8c1b475944b9cc8d04aed09e3292fbf7"><td class="memItemLeft" align="right" valign="top">public method&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classChemical_1_1LewisStructure.html#a8c1b475944b9cc8d04aed09e3292fbf7">isIsomorphic</a> ()</td></tr>
<tr class="separator:a8c1b475944b9cc8d04aed09e3292fbf7"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a5370a7da9c11ea9c4ac89066a1331623"><td class="memItemLeft" align="right" valign="top">public method&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classChemical_1_1LewisStructure.html#a5370a7da9c11ea9c4ac89066a1331623">generatePairings</a> ()</td></tr>
<tr class="separator:a5370a7da9c11ea9c4ac89066a1331623"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aab646cd0115094b00da2da4fe7ca40f2"><td class="memItemLeft" align="right" valign="top">public method&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classChemical_1_1LewisStructure.html#aab646cd0115094b00da2da4fe7ca40f2">getCirclePermutations</a> ()</td></tr>
<tr class="separator:aab646cd0115094b00da2da4fe7ca40f2"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aed2ea23f782b440539a2de14f8c740fb"><td class="memItemLeft" align="right" valign="top">public method&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classChemical_1_1LewisStructure.html#aed2ea23f782b440539a2de14f8c740fb">hashToMolFile</a> ()</td></tr>
<tr class="separator:aed2ea23f782b440539a2de14f8c740fb"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a438ecef1f56d8ea4636ff99a8389032b"><td class="memItemLeft" align="right" valign="top">public method&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classChemical_1_1LewisStructure.html#a438ecef1f56d8ea4636ff99a8389032b">copyMoleculeHash</a> ()</td></tr>
<tr class="separator:a438ecef1f56d8ea4636ff99a8389032b"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a775dcc845d2b941771bd7b9e91d69a55"><td class="memItemLeft" align="right" valign="top">public method&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classChemical_1_1LewisStructure.html#a775dcc845d2b941771bd7b9e91d69a55">generateHashFromLaTeXFormula</a> ()</td></tr>
<tr class="separator:a775dcc845d2b941771bd7b9e91d69a55"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="pub-static-attribs"></a>
Static Public Attributes</h2></td></tr>
<tr class="memitem:abe4e899eec6d0dc71aea394f3af38046"><td class="memItemLeft" align="right" valign="top"><a id="abe4e899eec6d0dc71aea394f3af38046"></a>
static hash&#160;</td><td class="memItemRight" valign="bottom"><b>idealBondCount</b></td></tr>
<tr class="separator:abe4e899eec6d0dc71aea394f3af38046"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<div class="textblock">
<p class="definition">Definition at line <a class="el" href="contextChemical_8pl_source.html#l00071">71</a> of file <a class="el" href="contextChemical_8pl_source.html">contextChemical.pl</a>.</p>
</div><h2 class="groupheader">Member Function Documentation</h2>
<a id="a6a5c508d640cb21907bfe2e0064b95be"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a6a5c508d640cb21907bfe2e0064b95be">&#9670;&nbsp;</a></span>compareKekuleCTABAndHash()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method Chemical::LewisStructure::compareKekuleCTABAndHash </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Undocumented Method </p>
<div id='codesection-compareKekuleCTABAndHash' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
	<img id='codesection-compareKekuleCTABAndHash-trigger' src='closed.png' alt='open/close icon' style='display:inline'/> <b>Code:</b>
</div>
<div id='codesection-compareKekuleCTABAndHash-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-compareKekuleCTABAndHash-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><div class="line"><span class="preprocessor"># Number of lines of code in compareKekuleCTABAndHash: 100</span></div>
<div class="line">sub <a class="code" href="classChemical_1_1LewisStructure.html#a6a5c508d640cb21907bfe2e0064b95be">compareKekuleCTABAndHash</a>(){</div>
<div class="line">    my $kekuleCTAB = shift;</div>
<div class="line">    my $moleculeHash = shift;</div>
<div class="line"> </div>
<div class="line">    @nodes = @{$kekuleCTAB-&gt;{nodes}};</div>
<div class="line">    $connectors = $kekuleCTAB-&gt;{connectors};</div>
<div class="line"> </div>
<div class="line">    @atoms = @{$moleculeHash-&gt;{atoms}};</div>
<div class="line">    $bonds = $moleculeHash-&gt;{bonds};</div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">    #my $result = isIsomorphic($nodes[0], $kekuleCTAB, $atoms[0], $moleculeHash);</span></div>
<div class="line">    <span class="keywordflow">if</span> (scalar @atoms != scalar @nodes){</div>
<div class="line">        my %failure = (atomsCorrect=&gt;0, bondOrderCorrect=&gt;0, formalChargesCorrect=&gt;0, lonePairsCorrect=&gt;0, badConnectors=&gt;[], badLonePairNodes=&gt;[], badFormalChargeNodes=&gt;[]);</div>
<div class="line">        <span class="keywordflow">return</span> \%failure;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span> (scalar @$bonds != scalar @$connectors){</div>
<div class="line">        my %failure = (atomsCorrect=&gt;0, bondOrderCorrect=&gt;0, formalChargesCorrect=&gt;0, lonePairsCorrect=&gt;0, badConnectors=&gt;[], badLonePairNodes=&gt;[], badFormalChargeNodes=&gt;[]);</div>
<div class="line">        <span class="keywordflow">return</span> \%failure;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">    # Find common node, start with unique atoms... or just try carbons and loop</span></div>
<div class="line"><span class="preprocessor">    # We should find least electronegative element, then tie-break with most bonds.</span></div>
<div class="line">    my $startAtom;</div>
<div class="line">    my $startNode;</div>
<div class="line">    my $leastElectronegative = 10;</div>
<div class="line">    map { </div>
<div class="line">        <span class="keywordflow">if</span> ($_-&gt;{enPauling} &lt; $leastElectronegative){</div>
<div class="line">            $leastElectronegative = $_-&gt;{enPauling};</div>
<div class="line">        }</div>
<div class="line">    } @atoms;</div>
<div class="line">    my @startAtomCandidates = grep {</div>
<div class="line">        $_-&gt;{enPauling} == $leastElectronegative }</div>
<div class="line">     @atoms;</div>
<div class="line"><span class="preprocessor">    #warn scalar @startAtomCandidates;</span></div>
<div class="line">    <span class="keywordflow">if</span> (scalar @startAtomCandidates == 1){</div>
<div class="line">        $startAtom = $startAtomCandidates[0];</div>
<div class="line">    } <span class="keywordflow">else</span> {</div>
<div class="line">        my $maxBonds = 0;</div>
<div class="line">        <span class="keywordflow">for</span> my $atom (@startAtomCandidates){</div>
<div class="line">            my $currentBondCount = 0;</div>
<div class="line">            map {</div>
<div class="line">                <span class="keywordflow">if</span> ($_-&gt;{1} == $atom || $_-&gt;{2} == $atom ){</div>
<div class="line">                    $currentBondCount++;</div>
<div class="line">                }</div>
<div class="line">            } @$bonds;</div>
<div class="line">            <span class="keywordflow">if</span> ($currentBondCount &gt; $maxBonds){</div>
<div class="line">                $maxBonds = $currentBondCount;</div>
<div class="line">                $startAtom = $atom;</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    $leastElectronegative = 10;</div>
<div class="line">    map {</div>
<div class="line">        my $node = $_;</div>
<div class="line">        my ($atomNumMinus1) = grep { $Chemical::Chemical::elements[$_] eq $node-&gt;{isotopeId} } 0 .. scalar @Chemical::Chemical::elements-1; </div>
<div class="line">        my $nodeElectronegativity = $Chemical::Chemical::paulingElectronegativities[$atomNumMinus1];</div>
<div class="line">        <span class="keywordflow">if</span> ($nodeElectronegativity &lt; $leastElectronegative){</div>
<div class="line">            $leastElectronegative = $nodeElectronegativity;</div>
<div class="line">        }</div>
<div class="line">        $node-&gt;{enPauling} = $nodeElectronegativity;</div>
<div class="line">    } @nodes;</div>
<div class="line"><span class="preprocessor">    #warn &quot;LEAST EN: $leastElectronegative&quot;;</span></div>
<div class="line">    my @startNodeCandidates = grep {</div>
<div class="line">        $_-&gt;{enPauling} == $leastElectronegative }</div>
<div class="line">    @nodes;</div>
<div class="line"><span class="preprocessor">    #warn &quot;StartNodeCandidates  &quot; . scalar @startNodeCandidates;</span></div>
<div class="line">    <span class="keywordflow">if</span> (scalar @startNodeCandidates == 1){</div>
<div class="line">        $startNode = $startNodeCandidates[0];</div>
<div class="line">    } <span class="keywordflow">else</span> {</div>
<div class="line">        my $maxConnectors = 0;</div>
<div class="line">        <span class="keywordflow">for</span> (my $i=0; $i &lt; scalar @startNodeCandidates; $i++){</div>
<div class="line">            my $node = $startNodeCandidates[$i];</div>
<div class="line">            my $currentConnectorCount = 0;</div>
<div class="line">            map {</div>
<div class="line">                <span class="keywordflow">if</span> ($_-&gt;{connectedObjs}-&gt;[0] == $i || $_-&gt;{connectedObjs}-&gt;[1] == $i ){</div>
<div class="line">                    $currentConnectorCount++;</div>
<div class="line">                }</div>
<div class="line">            } @$connectors;</div>
<div class="line">            <span class="keywordflow">if</span> ($currentConnectorCount &gt; $maxConnectors){</div>
<div class="line">                $maxConnectors = $currentConnectorCount;</div>
<div class="line">                $startNode = $node;</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> ($startNode-&gt;{isotopeId} ne  $Chemical::Chemical::elements[$startAtom-&gt;{atomNum} - 1] ){</div>
<div class="line">        my %failure = (atomsCorrect=&gt;0, bondOrderCorrect=&gt;0, formalChargesCorrect=&gt;0, lonePairsCorrect=&gt;0, badConnectors=&gt;[], badLonePairNodes=&gt;[], badFormalChargeNodes=&gt;[]);</div>
<div class="line">        <span class="keywordflow">return</span> \%failure;</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    <span class="keywordflow">return</span> <a class="code" href="classChemical_1_1LewisStructure.html#a8c1b475944b9cc8d04aed09e3292fbf7">isIsomorphic</a>($startNode, $kekuleCTAB, $startAtom, $moleculeHash);</div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">    # if ($nodes[0]-&gt;{isotopeId} ne  $Chemical::Chemical::elements[$atoms[0]-&gt;{atomNum} - 1] ){</span></div>
<div class="line"><span class="preprocessor">    #   my %failure = (atomsCorrect=&gt;0, bondOrderCorrect=&gt;0, formalChargesCorrect=&gt;0, lonePairsCorrect=&gt;0, badConnectors=&gt;[], badLonePairNodes=&gt;[], badFormalChargeNodes=&gt;[]);</span></div>
<div class="line"><span class="preprocessor">    #   return \%failure;</span></div>
<div class="line"><span class="preprocessor">    # }</span></div>
<div class="line">    </div>
<div class="line"><span class="preprocessor">    # isIsomorphic($nodes[0], $kekuleCTAB, $atoms[0], $moleculeHash);</span></div>
<div class="line"><span class="preprocessor">}</span></div>
</div><!-- fragment -->
</div>
 
</div>
</div>
<a id="a438ecef1f56d8ea4636ff99a8389032b"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a438ecef1f56d8ea4636ff99a8389032b">&#9670;&nbsp;</a></span>copyMoleculeHash()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method Chemical::LewisStructure::copyMoleculeHash </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Undocumented Method </p>
<div id='codesection-copyMoleculeHash' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
	<img id='codesection-copyMoleculeHash-trigger' src='closed.png' alt='open/close icon' style='display:inline'/> <b>Code:</b>
</div>
<div id='codesection-copyMoleculeHash-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-copyMoleculeHash-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><div class="line"><span class="preprocessor"># Number of lines of code in copyMoleculeHash: 39</span></div>
<div class="line">sub <a class="code" href="classChemical_1_1LewisStructure.html#a438ecef1f56d8ea4636ff99a8389032b">copyMoleculeHash</a> {</div>
<div class="line">    my $original = shift;</div>
<div class="line">    my %copy;</div>
<div class="line"> </div>
<div class="line">    my %atomDictionary = ();</div>
<div class="line">    my %bondDictionary = ();</div>
<div class="line"> </div>
<div class="line">    my @atoms;</div>
<div class="line"><span class="preprocessor">    # contain atom hash: {id, atomNum, charge, lonePairs, enPauling*, bonds}   * - included, but not needed</span></div>
<div class="line">    my @bonds;</div>
<div class="line"><span class="preprocessor">    # contain bond hash: {id, atom1, atom2, order, stereo?}  ? - not included, but maybe needed?</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">    #my %copy = (atomNum=&gt;$original-&gt;{atomNum}, count=&gt;$original-&gt;{count}, valence=&gt;$original-&gt;{valence}, enPauling=&gt;$original-&gt;{enPauling}, lonePairs=&gt;$original-&gt;{lonePairs}, bonds=&gt;$original-&gt;{atomNum});</span></div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">for</span> my $atom (@{$original-&gt;{atoms}}){</div>
<div class="line">        my %atomCopy = (<span class="keywordtype">id</span>=&gt;$atom-&gt;{<span class="keywordtype">id</span>}, atomNum=&gt;$atom-&gt;{atomNum}, count=&gt;$atom-&gt;{count}, valence=&gt;$atom-&gt;{valence}, enPauling=&gt;$atom-&gt;{enPauling}, lonePairs=&gt;$atom-&gt;{lonePairs}, charge=&gt;$atom-&gt;{charge}  );</div>
<div class="line"><span class="preprocessor">        # missing bonds</span></div>
<div class="line">        push(@atoms, \%atomCopy);</div>
<div class="line">        $atomDictionary{$atom} = \%atomCopy;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">for</span> my $bond (@{$original-&gt;{bonds}}) {</div>
<div class="line">        my %bondCopy = (<span class="keywordtype">id</span>=&gt;$bond-&gt;{<span class="keywordtype">id</span>}, 1=&gt; $atomDictionary{$bond-&gt;{1}}, 2=&gt; $atomDictionary{$bond-&gt;{2}}, order=&gt;$bond-&gt;{order});</div>
<div class="line">        push(@bonds, \%bondCopy);</div>
<div class="line">        $bondDictionary{$bond} = \%bondCopy;</div>
<div class="line">    }</div>
<div class="line"><span class="preprocessor">    # back to atoms, fill in bonds </span></div>
<div class="line">    <span class="keywordflow">for</span> my $atom (@{$original-&gt;{atoms}}){</div>
<div class="line">        $copy = $atomDictionary{$atom};</div>
<div class="line">        <span class="keywordflow">for</span> my $bond (@{$atom-&gt;{bonds}}){</div>
<div class="line">            push(@{$copy-&gt;{bonds}}, $bondDictionary{$bond});</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    $copy{atoms} = \@atoms;</div>
<div class="line">    $copy{bonds} = \@bonds;</div>
<div class="line">    $copy{formula} = $original{formula};</div>
<div class="line">    <span class="keywordflow">return</span> \%copy; </div>
<div class="line"> </div>
<div class="line">}</div>
</div><!-- fragment -->
</div>
 
</div>
</div>
<a id="a775dcc845d2b941771bd7b9e91d69a55"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a775dcc845d2b941771bd7b9e91d69a55">&#9670;&nbsp;</a></span>generateHashFromLaTeXFormula()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method Chemical::LewisStructure::generateHashFromLaTeXFormula </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Undocumented Method </p>
<div id='codesection-generateHashFromLaTeXFormula' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
	<img id='codesection-generateHashFromLaTeXFormula-trigger' src='closed.png' alt='open/close icon' style='display:inline'/> <b>Code:</b>
</div>
<div id='codesection-generateHashFromLaTeXFormula-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-generateHashFromLaTeXFormula-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><div class="line"><span class="preprocessor"># Number of lines of code in generateHashFromLaTeXFormula: 371</span></div>
<div class="line">sub <a class="code" href="classChemical_1_1LewisStructure.html#a775dcc845d2b941771bd7b9e91d69a55">generateHashFromLaTeXFormula</a> {</div>
<div class="line">    my $formula = shift;</div>
<div class="line"><span class="preprocessor">    # RETURNS hash ref {$formula, \@atoms, \@bonds}</span></div>
<div class="line"> </div>
<div class="line">    my $options = shift;</div>
<div class="line">    my $saveSteps = defined $options-&gt;{saveSteps} &amp;&amp; $options-&gt;{saveSteps};</div>
<div class="line">    my $showFormalCharges = defined $options-&gt;{showFormalCharges} &amp;&amp; $options-&gt;{showFormalCharges};</div>
<div class="line">    </div>
<div class="line">    my @steps = ();  # will be an array of hash where {title =&gt; string, hash =&gt; hash, electronsLeft =&gt; number}</div>
<div class="line"> </div>
<div class="line">    my @atoms;</div>
<div class="line"><span class="preprocessor">    # contain atom hash: {id, atomNum, charge, lonePairs, enPauling*, bonds}   * - included, but not needed</span></div>
<div class="line">    my @bonds;</div>
<div class="line"><span class="preprocessor">    # contain bond hash: {id, atom1, atom2, order, stereo?}  ? - not included, but maybe needed?</span></div>
<div class="line">    my @tempAtoms;</div>
<div class="line">    my @tempBonds;</div>
<div class="line"><span class="preprocessor">    # Parse formula</span></div>
<div class="line"><span class="preprocessor">    # Count elements using function in main Chemical package.</span></div>
<div class="line">    my $val = <a class="code" href="classChemical_1_1Chemical.html#a9b1f8253632a9b700455a0fced4d7ead">Chemical::Chemical::parseValue</a>($formula);</div>
<div class="line">    my $chemical = $val-&gt;{chemical};</div>
<div class="line">    </div>
<div class="line">    my $totalCharge = 0;</div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">    #need to flatten chemical array because it&#39;s setup to do polyatomics with an array of atomNum inside atomNum</span></div>
<div class="line">    my @deleteIndices;</div>
<div class="line">    my @elementsToAdd;</div>
<div class="line">    <span class="keywordflow">for</span> ($i=0; $i&lt;scalar @$chemical; $i++){</div>
<div class="line">        my %piece = %{$chemical-&gt;[$i]};</div>
<div class="line">        <span class="keywordflow">if</span> (ref $piece{atomNum} eq <span class="stringliteral">&quot;ARRAY&quot;</span>) {</div>
<div class="line">            push(@deleteIndices, $i);</div>
<div class="line">            $totalCharge += $piece{charge};</div>
<div class="line">            <span class="keywordflow">for</span> my $subAtom (@{$piece{atomNum}}){</div>
<div class="line">                my %atomHash = (atomNum=&gt;$subAtom, count=&gt;1, valence=&gt;$Chemical::Chemical::valenceStandardMap{$subAtom}, enPauling=&gt;$Chemical::Chemical::paulingElectronegativities[$subAtom-1], lonePairs=&gt;0, bonds=&gt;[]);</div>
<div class="line">                <span class="keywordflow">for</span>($j=0;$j&lt;$piece{count};$j++){</div>
<div class="line">                    my %copy = %atomHash; </div>
<div class="line">                    push(@elementsToAdd, \%copy);</div>
<div class="line">                }</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">for</span> (reverse @deleteIndices){</div>
<div class="line">        <span class="keyword">delete</span> @{$chemical}[$_];</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">for</span> (@elementsToAdd){</div>
<div class="line">        push(@$chemical,$_);</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    my $totalElectrons = 0; </div>
<div class="line">    my $valenceDetails = <span class="stringliteral">&#39;&#39;</span>;</div>
<div class="line">    map {</div>
<div class="line">        $totalElectrons += $_-&gt;{valence} * $_-&gt;{count};</div>
<div class="line">        <span class="keywordflow">if</span> ($valenceDetails ne <span class="stringliteral">&#39;&#39;</span>){</div>
<div class="line">            $valenceDetails .= <span class="stringliteral">&#39; + &#39;</span>;</div>
<div class="line">        }</div>
<div class="line">        $valenceDetails .=  $_-&gt;{count} . <span class="charliteral">&#39;(&#39;</span> . $_-&gt;{valence} .<span class="charliteral">&#39;)&#39;</span>; </div>
<div class="line">        } @$chemical;</div>
<div class="line">    $totalElectrons += ($totalCharge * -1);</div>
<div class="line">    <span class="keywordflow">if</span> ($totalCharge != 0){</div>
<div class="line">        $valenceDetails .= <span class="stringliteral">&#39; + &#39;</span> . ($totalCharge * -1) . <span class="stringliteral">&#39; (for charge)&#39;</span>;</div>
<div class="line">    }</div>
<div class="line">    $valenceDetails .= <span class="stringliteral">&quot; = $totalElectrons&quot;</span>;</div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">    # @tempAtoms = @atoms;</span></div>
<div class="line"><span class="preprocessor">    # @tempBonds = @bonds;</span></div>
<div class="line"><span class="preprocessor">    # warn &quot;TESTING&quot;;</span></div>
<div class="line"><span class="preprocessor">    # for my $atoms (@tempAtoms) {</span></div>
<div class="line"><span class="preprocessor">    #   warn %$atoms;</span></div>
<div class="line"><span class="preprocessor">    # }</span></div>
<div class="line"><span class="preprocessor">    # warn &quot;TOTAL&quot;;</span></div>
<div class="line"><span class="preprocessor">    #warn $totalElectrons;</span></div>
<div class="line">    <span class="keywordflow">if</span> ($saveSteps){</div>
<div class="line">        push(@steps, {</div>
<div class="line">            title=&gt;<span class="stringliteral">&quot;Count total valence electrons.&quot;</span>, </div>
<div class="line">            details=&gt;$valenceDetails, </div>
<div class="line">            hash=&gt;<a class="code" href="classChemical_1_1LewisStructure.html#a438ecef1f56d8ea4636ff99a8389032b">copyMoleculeHash</a>({<span class="stringliteral">&quot;formula&quot;</span>=&gt;$formula, <span class="stringliteral">&quot;atoms&quot;</span>=&gt;\@atoms, <span class="stringliteral">&quot;bonds&quot;</span>=&gt;\@bonds}), </div>
<div class="line">            electronsLeft=&gt;$totalElectrons</div>
<div class="line">            });</div>
<div class="line">    }</div>
<div class="line"><span class="preprocessor">    # 1. Sort by electronegativity, but put hydrogen LAST</span></div>
<div class="line"><span class="preprocessor">    # PGsort uses 0 for first is bigger and 1 for 2nd is bigger</span></div>
<div class="line"><span class="preprocessor">    # &lt;=&gt; uses 1 for 1st is bigger and -1 for 2nd is bigger (0 for equal)</span></div>
<div class="line">    my @enSorted = main::PGsort(sub {</div>
<div class="line">        <span class="keywordflow">if</span> ($_[0]-&gt;{atomNum} == 1){<span class="keywordflow">return</span> 0;}</div>
<div class="line">        elsif ($_[1]-&gt;{atomNum} == 1){ <span class="keywordflow">return</span> 1;}</div>
<div class="line">        <span class="keywordflow">else</span> {($_[0]-&gt;{enPauling} &lt;=&gt; $_[1]-&gt;{enPauling}) == 1 ? 0 : 1};</div>
<div class="line">    }, @$chemical);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (scalar @enSorted == 0){</div>
<div class="line">        warn <span class="stringliteral">&quot;shouldn&#39;t be here&quot;</span>;</div>
<div class="line">        <span class="keywordflow">return</span> <span class="stringliteral">&quot;&quot;</span>;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    my $sortedIndex=0;</div>
<div class="line">    my $centralCandidate = $enSorted[$sortedIndex];</div>
<div class="line"> </div>
<div class="line">    my $atomIndex=0;</div>
<div class="line">    my $bondIndex=0;</div>
<div class="line">    my @central;</div>
<div class="line">    my @terminal;</div>
<div class="line"><span class="preprocessor">    # 2. Check if multiple carbons in basic formula.... create chain.</span></div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> ($centralCandidate-&gt;{atomNum} == 6 &amp;&amp; $centralCandidate-&gt;{count} &gt; 1){</div>
<div class="line">        <span class="keywordflow">for</span> ($i=0; $i&lt;$centralCandidate-&gt;{count}; $i++){</div>
<div class="line">            my %copy = %$centralCandidate;</div>
<div class="line">            <span class="keyword">delete</span>($copy{count});</div>
<div class="line">            $copy{<span class="keywordtype">id</span>} = $atomIndex++; </div>
<div class="line">            push(@central, \%copy);</div>
<div class="line">            push(@atoms, \%copy);</div>
<div class="line">        }</div>
<div class="line">    } <span class="keywordflow">else</span>{</div>
<div class="line">        my %copy = %$centralCandidate;</div>
<div class="line">        <span class="keyword">delete</span>($copy{count}); </div>
<div class="line">        $copy{<span class="keywordtype">id</span>} = $atomIndex++; </div>
<div class="line">        push(@central, \%copy);</div>
<div class="line">        push(@atoms, \%copy);</div>
<div class="line">        <span class="keywordflow">for</span> ($i=1; $i&lt;$centralCandidate-&gt;{count}; $i++){</div>
<div class="line">            my %copy = %$centralCandidate;</div>
<div class="line">            <span class="keyword">delete</span>($copy{count}); </div>
<div class="line">            $copy{<span class="keywordtype">id</span>} = $atomIndex++; </div>
<div class="line">            push(@terminal, \%copy);</div>
<div class="line">            push(@atoms, \%copy);</div>
<div class="line"> </div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    $sortedIndex++;</div>
<div class="line">    <span class="keywordflow">while</span> ($sortedIndex &lt; scalar @enSorted){</div>
<div class="line">        my $nextAtom = $enSorted[$sortedIndex]; </div>
<div class="line">        <span class="keywordflow">for</span> ($i=0; $i&lt;$nextAtom-&gt;{count}; $i++){</div>
<div class="line">            my %copy = %$nextAtom;</div>
<div class="line">            <span class="keyword">delete</span>($copy{count});</div>
<div class="line">            $copy{<span class="keywordtype">id</span>} = $atomIndex++; </div>
<div class="line">            push(@terminal, \%copy);</div>
<div class="line">            push(@atoms, \%copy);</div>
<div class="line"> </div>
<div class="line">        }</div>
<div class="line">        $sortedIndex++;</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line"><span class="preprocessor">    # Make the connections. Terminal atom to central atoms.</span></div>
<div class="line"><span class="preprocessor">    # If carbon chain, take turns adding terminal atoms to each central atom. </span></div>
<div class="line"><span class="preprocessor">    # If carbon chain, make bonds between each carbon first.</span></div>
<div class="line">    my $centralIndex=0;</div>
<div class="line">    my %centralType = %{$central[0]};</div>
<div class="line">    my $connectionDetails = $Chemical::Chemical::elements[$centralType{atomNum}-1] . <span class="stringliteral">&#39; should be the central atom.&#39;</span>;</div>
<div class="line">    <span class="keywordflow">if</span> (scalar @central &amp;&amp; $centralType{atomNum} == 6){</div>
<div class="line">        $connectionDetails .= <span class="stringliteral">&#39; Since there are more than one, create a chain.&#39;</span>;</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    <span class="keywordflow">for</span> (my $i=1; $i&lt;scalar @central; $i++){</div>
<div class="line">        $totalElectrons -= 2;</div>
<div class="line">        my %newBond = (1=&gt; $central[$i-1], 2=&gt; $central[$i], order=&gt;1);</div>
<div class="line">        push(@bonds, \%newBond);</div>
<div class="line">        push(@{$central[$i-1]-&gt;{bonds}}, \%newBond);</div>
<div class="line">        push(@{$central[$i]-&gt;{bonds}}, \%newBond);</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    my $crashCount = 0;</div>
<div class="line">    <span class="keywordflow">for</span> my $terminalAtom (@terminal){</div>
<div class="line"><span class="preprocessor">        # Ensure atom does not already have X bonds for the atom type.</span></div>
<div class="line">        my $centralAtom = $central[$centralIndex];</div>
<div class="line"><span class="preprocessor">        #warn %{$centralAtom};</span></div>
<div class="line">        <span class="keywordflow">if</span> (! exists $centralAtom-&gt;{bonds}){</div>
<div class="line">            $centralAtom-&gt;{bonds} = [];</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">while</span> (exists $idealBondCount{$centralAtom-&gt;{atomNum}} &amp;&amp; scalar @{$centralAtom-&gt;{bonds}} == $idealBondCount{$centralAtom-&gt;{atomNum}}){</div>
<div class="line">            <span class="keywordflow">if</span> (scalar @central &gt; 1 &amp;&amp; $centralIndex &lt; scalar @central - 1 ){</div>
<div class="line">                $centralIndex++;</div>
<div class="line">            } <span class="keywordflow">else</span> {</div>
<div class="line">                $centralIndex = 0;</div>
<div class="line">            }</div>
<div class="line">            $centralAtom = $central[$centralIndex];</div>
<div class="line">            </div>
<div class="line">            $crashLoopCount++;</div>
<div class="line"><span class="preprocessor">            #warn $centralIndex;</span></div>
<div class="line">            <span class="keywordflow">if</span> ($crashLoopCount &gt; 20){</div>
<div class="line">                warn <span class="stringliteral">&quot;THIS IS BROKEN&quot;</span>;</div>
<div class="line">                last;</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">        </div>
<div class="line">        $totalElectrons -= 2;</div>
<div class="line">        my %newBond = (1=&gt; $centralAtom, 2=&gt; $terminalAtom, order=&gt;1);</div>
<div class="line">        push(@bonds, \%newBond);</div>
<div class="line">        push(@{$centralAtom-&gt;{bonds}}, \%newBond);</div>
<div class="line">        push(@{$terminalAtom-&gt;{bonds}}, \%newBond);</div>
<div class="line">        <span class="keywordflow">if</span> (scalar @central &gt; 1 &amp;&amp; $centralIndex &lt; scalar @central - 1 ){</div>
<div class="line">                $centralIndex++;</div>
<div class="line">            } <span class="keywordflow">else</span> {</div>
<div class="line">                $centralIndex = 0;</div>
<div class="line">            }</div>
<div class="line">        </div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> ($saveSteps){</div>
<div class="line">        push(@steps, {</div>
<div class="line">            title=&gt;<span class="stringliteral">&quot;Put least electronegative element in center (except hydrogen). If multiple carbons, connect those as a chain with single bonds.  Connect all other atoms with single bonds to the central atom(s).&quot;</span>,</div>
<div class="line">            details=&gt;$connectionDetails, </div>
<div class="line">            hash=&gt; <a class="code" href="classChemical_1_1LewisStructure.html#a438ecef1f56d8ea4636ff99a8389032b">copyMoleculeHash</a>({<span class="stringliteral">&quot;formula&quot;</span>=&gt;$formula, <span class="stringliteral">&quot;atoms&quot;</span>=&gt;\@atoms, <span class="stringliteral">&quot;bonds&quot;</span>=&gt;\@bonds}), </div>
<div class="line">            electronsLeft=&gt;$totalElectrons</div>
<div class="line">            });</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">    # we have a skeletal structure with single bonds.  Now do the octet rule for terminal atoms.</span></div>
<div class="line">    my $addedLonePairs=0;</div>
<div class="line">    <span class="keywordflow">for</span> my $terminalAtom (@terminal){</div>
<div class="line">        <span class="keywordflow">if</span> ($terminalAtom-&gt;{atomNum} &gt; 5){</div>
<div class="line"><span class="preprocessor">            # count current electrons (should be 2! -- let&#39;s skip this and hardcode 2 in for now)</span></div>
<div class="line"><span class="preprocessor">            # add 6 more electrons as lone pairs</span></div>
<div class="line">            <span class="keywordflow">if</span> ($totalElectrons &gt;= 6){</div>
<div class="line">                $terminalAtom-&gt;{lonePairs} = 3; </div>
<div class="line">                $totalElectrons -= 6;</div>
<div class="line">                $addedLonePairs += 3;</div>
<div class="line">            } <span class="keywordflow">else</span> {</div>
<div class="line">                warn $totalElectrons;</div>
<div class="line">                warn %$terminalAtom;</div>
<div class="line">                warn <span class="stringliteral">&quot;Don&#39;t think this should happen.&quot;</span></div>
<div class="line">            }</div>
<div class="line">        } <span class="keywordflow">else</span> {</div>
<div class="line"><span class="preprocessor">            # probably hydrogen terminal atom.  </span></div>
<div class="line"><span class="preprocessor">            # don&#39;t add any electrons.  </span></div>
<div class="line">            </div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> ($saveSteps){</div>
<div class="line">        push(@steps, {</div>
<div class="line">            title=&gt;<span class="stringliteral">&quot;Satisfy the octet rule for all outer/terminal atoms using lone pairs of electrons.&quot;</span>,</div>
<div class="line">            details=&gt;<span class="stringliteral">&quot;Added $addedLonePairs sets of lone pairs to the outer atoms.&quot;</span>,</div>
<div class="line">            hash=&gt;<a class="code" href="classChemical_1_1LewisStructure.html#a438ecef1f56d8ea4636ff99a8389032b">copyMoleculeHash</a>({<span class="stringliteral">&quot;formula&quot;</span>=&gt;$formula, <span class="stringliteral">&quot;atoms&quot;</span>=&gt;\@atoms, <span class="stringliteral">&quot;bonds&quot;</span>=&gt;\@bonds}), </div>
<div class="line">            electronsLeft=&gt;$totalElectrons</div>
<div class="line">            });</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">    # Do octet rule for central atom(s);</span></div>
<div class="line"><span class="preprocessor">    # Add leftover lonepairs to central atom.  If not, need to add extra bonds</span></div>
<div class="line">    my $nothingToDo = $totalElectrons &gt; 0 ? 0 : 1;</div>
<div class="line">    my $addedToCentral=0;</div>
<div class="line">    <span class="keywordflow">for</span> my $centralAtom (@central){</div>
<div class="line">        my $currentElectrons = 0;</div>
<div class="line">        map {</div>
<div class="line">            <span class="keywordflow">if</span> ($_-&gt;{1} == $centralAtom) {</div>
<div class="line">                $currentElectrons += ($_-&gt;{order} * 2);</div>
<div class="line">            } elsif ($_-&gt;{2} == $centralAtom) {</div>
<div class="line">                $currentElectrons += ($_-&gt;{order} * 2);</div>
<div class="line">            }</div>
<div class="line">            } @bonds;</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">while</span> ($totalElectrons &gt; 0) {</div>
<div class="line">            <span class="keywordflow">if</span> ($totalElectrons == 1){</div>
<div class="line"><span class="preprocessor">                # do something special... TBD</span></div>
<div class="line">            } <span class="keywordflow">else</span> {</div>
<div class="line"><span class="preprocessor">                # need to add electrons to central atom regardless of octet rules</span></div>
<div class="line">                $centralAtom-&gt;{lonePairs} += 1;</div>
<div class="line">                $totalElectrons -= 2;</div>
<div class="line">                $currentElectrons += 2;</div>
<div class="line">                $addedToCentral += 2;</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        push(@steps, {</div>
<div class="line">            title=&gt;<span class="stringliteral">&quot;Try to satisfy the octet rule for each cental atom with the remaining electrons. Remember that not all atoms require an octet to be stable.&quot;</span>,</div>
<div class="line">            details=&gt;$nothingToDo ? <span class="stringliteral">&quot;There are no remaining electrons to add to the central atom.&quot;</span> : <span class="stringliteral">&quot;Put the $addedToCentral electrons on the central atom.&quot;</span>,</div>
<div class="line">            hash=&gt;<a class="code" href="classChemical_1_1LewisStructure.html#a438ecef1f56d8ea4636ff99a8389032b">copyMoleculeHash</a>({<span class="stringliteral">&quot;formula&quot;</span>=&gt;$formula, <span class="stringliteral">&quot;atoms&quot;</span>=&gt;\@atoms, <span class="stringliteral">&quot;bonds&quot;</span>=&gt;\@bonds}), </div>
<div class="line">            electronsLeft=&gt;$totalElectrons});</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> ($centralAtom-&gt;{atomNum} &gt; 5 &amp;&amp; $currentElectrons &lt; 8){</div>
<div class="line"><span class="preprocessor">            # Central atom needs more electrons</span></div>
<div class="line"><span class="preprocessor">            # share lone pairs from terminal atoms OR other central atoms</span></div>
<div class="line">            my @centralCandidates = grep {$_-&gt;{lonePairs} &amp;&amp; $_ != $centralAtom} @central;</div>
<div class="line">            my @terminalCandidates = grep {$_-&gt;{lonePairs}} @terminal;</div>
<div class="line">            my @candidates = (@centralCandidates, @terminalCandidates);</div>
<div class="line"><span class="preprocessor">            # choose candidate(s) least likely to leave bad formal charge.</span></div>
<div class="line"><span class="preprocessor">            # for now, we&#39;ll do 2 at a time </span></div>
<div class="line"><span class="preprocessor">            #   1.  if candidates are the same valence, do them in sequence</span></div>
<div class="line"><span class="preprocessor">            #   2.  if candidates have different valence, ALWAYS remove lp from lower valence.</span></div>
<div class="line">            my $crashCount = 0;</div>
<div class="line"><span class="preprocessor">            # my $foundValenceCandidates = 0;</span></div>
<div class="line"><span class="preprocessor">            #my @usedTerminalAtoms = ();</span></div>
<div class="line">            <span class="keywordflow">while</span> ($currentElectrons &lt; 8){</div>
<div class="line">                my $lowestValence = 100;</div>
<div class="line">                map {<span class="keywordflow">if</span> ($_-&gt;{valence} &lt; $lowestValence) {$lowestValence = $_-&gt;{valence}}} @candidates;</div>
<div class="line">                @lowestValenceCandidates = grep {$_-&gt;{valence} == $lowestValence} @candidates;</div>
<div class="line"><span class="preprocessor">                # if (scalar @lowestValenceCandidates &gt; 0){</span></div>
<div class="line"><span class="preprocessor">                #   $foundValenceCandidates = 1;</span></div>
<div class="line"><span class="preprocessor">                # }</span></div>
<div class="line">                <span class="keywordflow">for</span> my $valenceCandidate (@lowestValenceCandidates){</div>
<div class="line">                    <span class="keywordflow">if</span> ($valenceCandidate-&gt;{lonePairs} &gt; 0){</div>
<div class="line">                        $valenceCandidate-&gt;{lonePairs}--;</div>
<div class="line">                        $currentElectrons += 2;</div>
<div class="line"><span class="preprocessor">                        # need to increase bond order... find bond</span></div>
<div class="line">                        ($foundBond) = grep {($_-&gt;{1} == $centralAtom &amp;&amp; $_-&gt;{2} == $valenceCandidate) </div>
<div class="line">                            || ($_-&gt;{2} == $centralAtom &amp;&amp; $_-&gt;{1} == $valenceCandidate)} @bonds;</div>
<div class="line">                        $foundBond-&gt;{order}++;</div>
<div class="line"><span class="preprocessor">                        # push(@usedTerminalAtoms, $valenceCandidate);</span></div>
<div class="line">                        <span class="keywordflow">if</span> ($currentElectrons == 8){</div>
<div class="line">                            last;</div>
<div class="line">                        }</div>
<div class="line">                    }</div>
<div class="line">                }</div>
<div class="line">                $crashLoopCount++;</div>
<div class="line">                <span class="keywordflow">if</span> ($crashLoopCount &gt; 10){</div>
<div class="line">                    warn <span class="stringliteral">&quot;THIS IS BROKEN&quot;</span>;</div>
<div class="line">                    last;</div>
<div class="line">                }</div>
<div class="line">            }</div>
<div class="line"> </div>
<div class="line">            my $details = <span class="stringliteral">&#39;&#39;</span>;</div>
<div class="line">            <span class="keywordflow">if</span> (scalar @lowestValenceCandidates == 1){</div>
<div class="line">                $details = <span class="stringliteral">&quot;Sharing electrons from &quot;</span> . $Chemical::Chemical::elements[$lowestValenceCandidates[0]-&gt;{atomNum}-1] . <span class="stringliteral">&quot; will give the best lewis structure.&quot;</span>;</div>
<div class="line">            } <span class="keywordflow">else</span> {</div>
<div class="line"><span class="preprocessor">                # HERE&#39;S WHERE WE CAN IDENTIFY RESONANCE STRUCTURES!</span></div>
<div class="line">                $details = <span class="stringliteral">&quot;Sharing electrons from &quot;</span> . $Chemical::Chemical::elements[$lowestValenceCandidates[0]-&gt;{atomNum}-1] . <span class="stringliteral">&quot; will give the best lewis structure.&quot;</span>;</div>
<div class="line"><span class="preprocessor">                #map { $details = &quot;Sharing electrons from &quot;} @lowestValenceCandidates;</span></div>
<div class="line">            }</div>
<div class="line">            </div>
<div class="line"> </div>
<div class="line">            push(@steps, {</div>
<div class="line">                title=&gt;<span class="stringliteral">&quot;Since central atom needed more electrons than was available, share a lone pair of electrons from a terminal atom with the central atom as an extra bond.    Remember if there are multiple options, pick the one that will leave you with the most ideal formal charges.&quot;</span>,</div>
<div class="line">                details=&gt; $details,</div>
<div class="line">                hash=&gt;<a class="code" href="classChemical_1_1LewisStructure.html#a438ecef1f56d8ea4636ff99a8389032b">copyMoleculeHash</a>({<span class="stringliteral">&quot;formula&quot;</span>=&gt;$formula, <span class="stringliteral">&quot;atoms&quot;</span>=&gt;\@atoms, <span class="stringliteral">&quot;bonds&quot;</span>=&gt;\@bonds}), </div>
<div class="line">                electronsLeft=&gt;$totalElectrons});</div>
<div class="line">            </div>
<div class="line">        }</div>
<div class="line">        </div>
<div class="line">    }</div>
<div class="line">    $details = <span class="stringliteral">&#39;&#39;</span>;</div>
<div class="line"><span class="preprocessor">    # subroutine for finding Formal Charge</span></div>
<div class="line">    <span class="keywordflow">for</span> my $atom (@atoms){</div>
<div class="line">        my $atomElectrons = 0;</div>
<div class="line">        map {</div>
<div class="line">            <span class="keywordflow">if</span> ($_-&gt;{1} == $atom) {</div>
<div class="line">                $atomElectrons += ($_-&gt;{order} * 2);</div>
<div class="line">            } elsif ($_-&gt;{2} == $atom) {</div>
<div class="line">                $atomElectrons += ($_-&gt;{order} * 2);</div>
<div class="line">            }</div>
<div class="line">            } @bonds;</div>
<div class="line">        my $formalCharge = $atom-&gt;{valence} - ($atomElectrons / 2) - (exists($atom-&gt;{lonePairs}) ? $atom-&gt;{lonePairs} * 2 : 0);</div>
<div class="line">        $atom-&gt;{charge} = $formalCharge;</div>
<div class="line">        <span class="keywordflow">if</span> ($saveSteps){</div>
<div class="line">            warn $formalCharge;</div>
<div class="line">            warn %$atom;        </div>
<div class="line">            warn <span class="stringliteral">&quot;ADDED FORMAL CHARGES&quot;</span>;</div>
<div class="line">            $details .= $atom-&gt;{charge} . <span class="stringliteral">&#39;  &#39;</span>;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span> ($saveSteps &amp;&amp; $showFormalCharges){</div>
<div class="line">        push(@steps, {</div>
<div class="line">            title=&gt;<span class="stringliteral">&quot;Calculate formal charges.&quot;</span>,</div>
<div class="line">            details=&gt; <span class="stringliteral">&quot;Formal Charge = Valence Electrons - lone pair electrons - (0.5 * bonding electrons)&quot;</span>,</div>
<div class="line">            hash=&gt;<a class="code" href="classChemical_1_1LewisStructure.html#a438ecef1f56d8ea4636ff99a8389032b">copyMoleculeHash</a>({<span class="stringliteral">&quot;formula&quot;</span>=&gt;$formula, <span class="stringliteral">&quot;atoms&quot;</span>=&gt;\@atoms, <span class="stringliteral">&quot;bonds&quot;</span>=&gt;\@bonds}), </div>
<div class="line">            electronsLeft=&gt;$totalElectrons</div>
<div class="line">            });</div>
<div class="line">    }</div>
<div class="line"><span class="preprocessor">    # warn &quot;ATOMS&quot;;</span></div>
<div class="line"><span class="preprocessor">    # for $atom (@atoms){</span></div>
<div class="line"><span class="preprocessor">    #   warn %{$atom};</span></div>
<div class="line"><span class="preprocessor">    # }</span></div>
<div class="line"><span class="preprocessor">    # warn &quot;BONDS&quot;;</span></div>
<div class="line"><span class="preprocessor">    # for $bond (@bonds){</span></div>
<div class="line"><span class="preprocessor">    #   warn %{$bond};</span></div>
<div class="line"><span class="preprocessor">    # }</span></div>
<div class="line"> </div>
<div class="line">    %result = (<span class="stringliteral">&quot;formula&quot;</span>=&gt;$formula, <span class="stringliteral">&quot;atoms&quot;</span>=&gt;\@atoms, <span class="stringliteral">&quot;bonds&quot;</span>=&gt;\@bonds);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> ($saveSteps){</div>
<div class="line">        <span class="keywordflow">return</span> \@steps;</div>
<div class="line">    } <span class="keywordflow">else</span> {</div>
<div class="line">        <span class="keywordflow">return</span> \%result;</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment -->
</div>
 
</div>
</div>
<a id="a5370a7da9c11ea9c4ac89066a1331623"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a5370a7da9c11ea9c4ac89066a1331623">&#9670;&nbsp;</a></span>generatePairings()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method Chemical::LewisStructure::generatePairings </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Undocumented Method </p>
<div id='codesection-generatePairings' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
	<img id='codesection-generatePairings-trigger' src='closed.png' alt='open/close icon' style='display:inline'/> <b>Code:</b>
</div>
<div id='codesection-generatePairings-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-generatePairings-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><div class="line"><span class="preprocessor"># Number of lines of code in generatePairings: 48</span></div>
<div class="line">sub <a class="code" href="classChemical_1_1LewisStructure.html#a5370a7da9c11ea9c4ac89066a1331623">generatePairings</a> {</div>
<div class="line">    my $arrayRef1=shift;</div>
<div class="line">    my $arrayRef2=shift;</div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#warn scalar @$arrayRef1;</span></div>
<div class="line"><span class="preprocessor"># warn scalar @$arrayRef2;</span></div>
<div class="line">    <span class="keywordflow">if</span> (scalar @$arrayRef1 != scalar @$arrayRef2){</div>
<div class="line">        warn <span class="stringliteral">&quot;THEY ARE NOT THE SAME!&quot;</span>;</div>
<div class="line">        <span class="keywordflow">return</span> ();</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    my $permutations = <a class="code" href="classChemical_1_1LewisStructure.html#aab646cd0115094b00da2da4fe7ca40f2">getCirclePermutations</a>(scalar @$arrayRef1);</div>
<div class="line"><span class="preprocessor">    #warn &quot;Permutations: &quot; . scalar @$permutations;</span></div>
<div class="line">    my @sets = ();</div>
<div class="line">    <span class="keywordflow">for</span> my $perm (@$permutations){</div>
<div class="line"><span class="preprocessor">        #warn &quot;inside perm: &quot; . scalar @$perm;</span></div>
<div class="line">        </div>
<div class="line"><span class="preprocessor">        #for my $col (@$perm){</span></div>
<div class="line">        </div>
<div class="line">        <span class="keywordflow">for</span> (my $it=0; $it &lt; scalar @$perm; $it++){</div>
<div class="line">            my @set = (); </div>
<div class="line">            <span class="keywordflow">for</span> (my $row=0; $row &lt; scalar @$perm; $row++){</div>
<div class="line">                </div>
<div class="line">                my $first = $arrayRef1-&gt;[$row];</div>
<div class="line">                my $col = $it + $row &gt;= scalar @$perm ? ($it + $row - scalar @$perm) : $it + $row;</div>
<div class="line"><span class="preprocessor">                # warn &quot;COL $col&quot;;</span></div>
<div class="line"><span class="preprocessor">                # warn &quot;PERM &quot;;</span></div>
<div class="line"><span class="preprocessor">                # warn @$perm;</span></div>
<div class="line"><span class="preprocessor">                #warn $perm-&gt;[$col];</span></div>
<div class="line">                my $second = $arrayRef2-&gt;[$perm-&gt;[$col]];</div>
<div class="line">                my @pair = ($first, $second);</div>
<div class="line">                push(@set, \@pair);</div>
<div class="line">            }</div>
<div class="line">            push(@sets, \@set);</div>
<div class="line">        }</div>
<div class="line">        </div>
<div class="line"><span class="preprocessor">        #}</span></div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line"><span class="preprocessor">    # for my $t(@sets){</span></div>
<div class="line"><span class="preprocessor">    #   for my $t2(@$t){</span></div>
<div class="line"><span class="preprocessor">    #       warn &quot;array combination&quot;;</span></div>
<div class="line"><span class="preprocessor">    #       warn @$t2;</span></div>
<div class="line"><span class="preprocessor">    #   }</span></div>
<div class="line"><span class="preprocessor">    # }</span></div>
<div class="line"><span class="preprocessor">    #warn &quot;Generated &quot; . scalar @sets;</span></div>
<div class="line">    <span class="keywordflow">return</span> \@sets; </div>
<div class="line">}</div>
</div><!-- fragment -->
</div>
 
</div>
</div>
<a id="aab646cd0115094b00da2da4fe7ca40f2"></a>
<h2 class="memtitle"><span class="permalink"><a href="#aab646cd0115094b00da2da4fe7ca40f2">&#9670;&nbsp;</a></span>getCirclePermutations()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method Chemical::LewisStructure::getCirclePermutations </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Undocumented Method </p>
<div id='codesection-getCirclePermutations' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
	<img id='codesection-getCirclePermutations-trigger' src='closed.png' alt='open/close icon' style='display:inline'/> <b>Code:</b>
</div>
<div id='codesection-getCirclePermutations-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-getCirclePermutations-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><div class="line"><span class="preprocessor"># Number of lines of code in getCirclePermutations: 46</span></div>
<div class="line">sub <a class="code" href="classChemical_1_1LewisStructure.html#aab646cd0115094b00da2da4fe7ca40f2">getCirclePermutations</a> {</div>
<div class="line">    my $count = shift;</div>
<div class="line">    my $listRef = shift;</div>
<div class="line">    my $pieceRef = shift;</div>
<div class="line">    my $choicesRef = shift;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (!defined $listRef){</div>
<div class="line">        my @tempList = ();</div>
<div class="line">        $listRef = \@tempList;</div>
<div class="line">    } </div>
<div class="line">    </div>
<div class="line">    <span class="keywordflow">if</span> (defined $pieceRef){</div>
<div class="line"><span class="preprocessor">    #   @piece = @$pieceRef;</span></div>
<div class="line">    } <span class="keywordflow">else</span> {</div>
<div class="line">        $pieceRef = [];</div>
<div class="line">        push(@$pieceRef, 0);</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    my @choices;</div>
<div class="line">    <span class="keywordflow">if</span> (defined $choicesRef){</div>
<div class="line">        @choices = @$choicesRef;</div>
<div class="line">    } <span class="keywordflow">else</span> {</div>
<div class="line">        @choices = (1..$count-1);</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    </div>
<div class="line">    <span class="keywordflow">for</span> my $item (@choices){</div>
<div class="line">        my @choicesCopy = @choices;</div>
<div class="line">        my @pieceCopy = @$pieceRef;</div>
<div class="line">        push (@pieceCopy, $item);</div>
<div class="line">        </div>
<div class="line">        my $index = 0;</div>
<div class="line">        $index++ until $choicesCopy[$index] eq $item;</div>
<div class="line">        splice(@choicesCopy, $index, 1);</div>
<div class="line">        $listRef = <a class="code" href="classChemical_1_1LewisStructure.html#aab646cd0115094b00da2da4fe7ca40f2">getCirclePermutations</a>($count,  $listRef, \@pieceCopy, \@choicesCopy);</div>
<div class="line">        $index++;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (scalar @$pieceRef == $count){</div>
<div class="line">            push(@$listRef, $pieceRef);</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    </div>
<div class="line">    <span class="keywordflow">return</span> $listRef;</div>
<div class="line">}</div>
</div><!-- fragment -->
</div>
 
</div>
</div>
<a id="aed2ea23f782b440539a2de14f8c740fb"></a>
<h2 class="memtitle"><span class="permalink"><a href="#aed2ea23f782b440539a2de14f8c740fb">&#9670;&nbsp;</a></span>hashToMolFile()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method Chemical::LewisStructure::hashToMolFile </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Undocumented Method </p>
<div id='codesection-hashToMolFile' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
	<img id='codesection-hashToMolFile-trigger' src='closed.png' alt='open/close icon' style='display:inline'/> <b>Code:</b>
</div>
<div id='codesection-hashToMolFile-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-hashToMolFile-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><div class="line"><span class="preprocessor"># Number of lines of code in hashToMolFile: 87</span></div>
<div class="line">sub <a class="code" href="classChemical_1_1LewisStructure.html#aed2ea23f782b440539a2de14f8c740fb">hashToMolFile</a> {</div>
<div class="line">    my $structure = shift;</div>
<div class="line">    my $options = shift;</div>
<div class="line">    my $addLonePairs = defined $options-&gt;{withLonePairs} &amp;&amp; $options-&gt;{withLonePairs};</div>
<div class="line">    my $noCharges = defined $options-&gt;{noCharges} &amp;&amp; $options-&gt;{noCharges};</div>
<div class="line">    my $onlySingleBonds = defined $options-&gt;{onlySingleBonds} &amp;&amp; $options-&gt;{onlySingleBonds};</div>
<div class="line"><span class="preprocessor">    # for my $testAtom (@{$structure-&gt;{atoms}}){</span></div>
<div class="line"><span class="preprocessor">    #   warn %$testAtom;</span></div>
<div class="line"><span class="preprocessor">    # }</span></div>
<div class="line"><span class="preprocessor">    #hash ref {$formula, \@atoms, \@bonds}</span></div>
<div class="line">    </div>
<div class="line">    my $totalLonePairs = 0;</div>
<div class="line">    map {</div>
<div class="line">        <span class="keywordflow">if</span> (defined $_-&gt;{lonePairs}){</div>
<div class="line">            $totalLonePairs += $_-&gt;{lonePairs};</div>
<div class="line">        }</div>
<div class="line">    } @{$structure-&gt;{atoms}};</div>
<div class="line">    </div>
<div class="line">    my $mol = $structure-&gt;{formula} . <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line"><span class="preprocessor">    #$mol .= $structure-&gt;{atoms}-&gt;[1]-&gt;{charge};</span></div>
<div class="line">    $mol .= <span class="stringliteral">&quot;WeBWorKChemistry&quot;</span> . time . <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">    $mol .= <span class="stringliteral">&quot;Comment line \n&quot;</span>;</div>
<div class="line"><span class="preprocessor">    # the atoms count is going to be wrong if I include lonepairs</span></div>
<div class="line">    $mol .=  sprintf(<span class="stringliteral">&#39;%3s&#39;</span>, scalar @{$structure-&gt;{atoms}} + ($addLonePairs ? $totalLonePairs : 0)) . sprintf(<span class="stringliteral">&#39;%3s&#39;</span>, scalar @{$structure-&gt;{bonds}} + ($addLonePairs ? $totalLonePairs : 0)) . <span class="stringliteral">&#39;  0  0  0  0  0  0  0999 V2000&#39;</span> . <span class="stringliteral">&quot;\n&quot;</span>;  #additional properties not handled yet</div>
<div class="line">    my $zero = <span class="stringliteral">&#39;    0.0000&#39;</span>;</div>
<div class="line">    my $atomIndex = 1;</div>
<div class="line">    my $lonePairIndex= @{$structure-&gt;{atoms}} + 1;</div>
<div class="line">    my @futureBonds = ();</div>
<div class="line">    <span class="keywordflow">for</span> my $atom (@{$structure-&gt;{atoms}}){</div>
<div class="line">        my $element = $Chemical::Chemical::elements[$atom-&gt;{atomNum}-1];</div>
<div class="line">        my $charge = 0;# = $atom-&gt;{charge};</div>
<div class="line">        <span class="keywordflow">if</span> (!$noCharges){</div>
<div class="line"><span class="preprocessor">            #</span></div>
<div class="line">            <span class="keywordflow">if</span> (exists $atom-&gt;{charge}){</div>
<div class="line">                <span class="keywordflow">if</span>  ($atom-&gt;{charge} == 3) {</div>
<div class="line">                    $charge = 1</div>
<div class="line">                } elsif ($atom-&gt;{charge} == 2){</div>
<div class="line">                        $charge = 2;</div>
<div class="line">                } elsif ($atom-&gt;{charge} == 1){</div>
<div class="line">                    $charge = 3</div>
<div class="line">                } elsif ($atom-&gt;{charge} == -1){</div>
<div class="line">                    $charge = 5</div>
<div class="line">                } elsif ($atom-&gt;{charge} == -2){</div>
<div class="line">                    $charge = 6</div>
<div class="line">                } elsif ($atom-&gt;{charge} == -3){</div>
<div class="line">                    $charge = 7</div>
<div class="line">                } <span class="keywordflow">else</span> {</div>
<div class="line">                    $charge = 0</div>
<div class="line">                }</div>
<div class="line">            }</div>
<div class="line">        } <span class="keywordflow">else</span> {</div>
<div class="line">            $charge = 0;</div>
<div class="line">        }</div>
<div class="line">        $mol .= <span class="stringliteral">&quot;$zero$zero$zero &quot;</span> . sprintf(<span class="stringliteral">&#39;%3s&#39;</span>, $element) . <span class="stringliteral">&#39; 0&#39;</span> . sprintf(<span class="stringliteral">&#39;%3s&#39;</span>, $charge) . <span class="stringliteral">&#39;  0&#39;</span> . <span class="stringliteral">&#39;  1&#39;</span> . <span class="stringliteral">&#39;  0&#39;</span> . <span class="stringliteral">&#39;  0&#39;</span> . <span class="stringliteral">&#39;  0&#39;</span> . <span class="stringliteral">&#39;  0&#39;</span>. <span class="stringliteral">&#39;  0&#39;</span>. <span class="stringliteral">&#39;  0&#39;</span>. <span class="stringliteral">&#39;  0&#39;</span>. <span class="stringliteral">&#39;  0&#39;</span>. <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line"><span class="preprocessor">        #$mol .= sprintf(&#39;%3s&#39;, $bond-&gt;{1}-&gt;{id} + 1) . sprintf(&#39;%3s&#39;, $bond-&gt;{2}-&gt;{id} + 1) . sprintf(&#39;%3s&#39;, $onlySingleBonds ? &#39;1&#39; : $bond-&gt;{order}) . &#39;  0&#39; . &#39;  0&#39; . &#39;  0&#39; . &#39;  0&#39; .&quot;\n&quot;;</span></div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">    # OpenBabel resolves a LP as an unknown atom with label &quot;A&quot;</span></div>
<div class="line">    <span class="keywordflow">if</span> ($addLonePairs){</div>
<div class="line">        <span class="keywordflow">for</span> my $atom (@{$structure-&gt;{atoms}}){</div>
<div class="line">            <span class="keywordflow">if</span> (defined $atom-&gt;{lonePairs} &amp;&amp; $atom-&gt;{lonePairs} &gt; 0){</div>
<div class="line">                my $lonePairs = $atom-&gt;{lonePairs};</div>
<div class="line">                <span class="keywordflow">foreach</span> my $LPIndex (0..$lonePairs-1){</div>
<div class="line">                    warn <span class="stringliteral">&quot;LONE PAIR: $LPIndex&quot;</span>;</div>
<div class="line">                    $mol .= <span class="stringliteral">&quot;$zero$zero$zero &quot;</span> . sprintf(<span class="stringliteral">&#39;%3s&#39;</span>, <span class="stringliteral">&#39;LP&#39;</span>) . <span class="stringliteral">&#39; 0&#39;</span> . sprintf(<span class="stringliteral">&#39;%3s&#39;</span>, <span class="charliteral">&#39;0&#39;</span>) . <span class="stringliteral">&#39;  0&#39;</span> . <span class="stringliteral">&#39;  1&#39;</span> . <span class="stringliteral">&#39;  0&#39;</span> . <span class="stringliteral">&#39;  0&#39;</span> . <span class="stringliteral">&#39;  0&#39;</span> . <span class="stringliteral">&#39;  0&#39;</span>. <span class="stringliteral">&#39;  0&#39;</span>. <span class="stringliteral">&#39;  0&#39;</span>. <span class="stringliteral">&#39;  0&#39;</span>. <span class="stringliteral">&#39;  0&#39;</span>. <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">                    my $futureBond = sprintf(<span class="stringliteral">&#39;%3s&#39;</span>, $lonePairIndex) . sprintf(<span class="stringliteral">&#39;%3s&#39;</span>, $atomIndex) . sprintf(<span class="stringliteral">&#39;%3s&#39;</span>, <span class="charliteral">&#39;1&#39;</span>) . <span class="stringliteral">&#39;  0&#39;</span> . <span class="stringliteral">&#39;  0&#39;</span> . <span class="stringliteral">&#39;  0&#39;</span> . <span class="stringliteral">&#39;  0&#39;</span> .<span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">                    push(@futureBonds,$futureBond); </div>
<div class="line">                    $lonePairIndex++;</div>
<div class="line">                }</div>
<div class="line">            }</div>
<div class="line">            $atomIndex++;</div>
<div class="line"><span class="preprocessor">            #$mol .= &quot;$zero$zero$zero &quot; . sprintf(&#39;%3s&#39;, $element) . &#39; 0&#39; . sprintf(&#39;%3s&#39;, $charge) . &#39;  0&#39; . &#39;  1&#39; . &#39;  0&#39; . &#39;  0&#39; . &#39;  0&#39; . &#39;  0&#39;. &#39;  0&#39;. &#39;  0&#39;. &#39;  0&#39;. &#39;  0&#39;. &quot;\n&quot;;</span></div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">for</span> my $bond (@{$structure-&gt;{bonds}}) {</div>
<div class="line">        $mol .= sprintf(<span class="stringliteral">&#39;%3s&#39;</span>, $bond-&gt;{1}-&gt;{<span class="keywordtype">id</span>} + 1) . sprintf(<span class="stringliteral">&#39;%3s&#39;</span>, $bond-&gt;{2}-&gt;{<span class="keywordtype">id</span>} + 1) . sprintf(<span class="stringliteral">&#39;%3s&#39;</span>, $onlySingleBonds ? <span class="charliteral">&#39;1&#39;</span> : $bond-&gt;{order}) . <span class="stringliteral">&#39;  0&#39;</span> . <span class="stringliteral">&#39;  0&#39;</span> . <span class="stringliteral">&#39;  0&#39;</span> . <span class="stringliteral">&#39;  0&#39;</span> .<span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span> ($addLonePairs){</div>
<div class="line">        <span class="keywordflow">for</span> my $lpbond (@futureBonds){</div>
<div class="line">            $mol .= $lpbond;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"><span class="preprocessor">    # skipped property block ...</span></div>
<div class="line"> </div>
<div class="line">    $mol .= <span class="stringliteral">&quot;M  END\n&quot;</span>;</div>
<div class="line">    <span class="keywordflow">return</span> $mol;</div>
<div class="line">}</div>
</div><!-- fragment -->
</div>
 
</div>
</div>
<a id="a8c1b475944b9cc8d04aed09e3292fbf7"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a8c1b475944b9cc8d04aed09e3292fbf7">&#9670;&nbsp;</a></span>isIsomorphic()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method Chemical::LewisStructure::isIsomorphic </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Undocumented Method </p>
<div id='codesection-isIsomorphic' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
	<img id='codesection-isIsomorphic-trigger' src='closed.png' alt='open/close icon' style='display:inline'/> <b>Code:</b>
</div>
<div id='codesection-isIsomorphic-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-isIsomorphic-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><div class="line"><span class="preprocessor"># Number of lines of code in isIsomorphic: 354</span></div>
<div class="line">sub <a class="code" href="classChemical_1_1LewisStructure.html#a8c1b475944b9cc8d04aed09e3292fbf7">isIsomorphic</a>() {</div>
<div class="line">    my $node = shift;</div>
<div class="line">    my $kekuleCTAB = shift;</div>
<div class="line">    my $atom = shift;</div>
<div class="line">    my $moleculeHash = shift;</div>
<div class="line"><span class="preprocessor">    # When finding combinations of bonds to check for isomorphism, we have to keep track of paths we&#39;ve already gone down.</span></div>
<div class="line"><span class="preprocessor">    # This isn&#39;t a regular tree with a well defined root and a path to follow down.  </span></div>
<div class="line">    my $lastConnector = shift; </div>
<div class="line">    my $lastBond = shift;</div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">    # warn &quot;last connector&quot;;</span></div>
<div class="line"><span class="preprocessor">    # warn %$lastConnector;</span></div>
<div class="line"> </div>
<div class="line">    my %success = (atomsCorrect=&gt;1, bondOrderCorrect=&gt;1, formalChargesCorrect=&gt;1, lonePairsCorrect=&gt;1, badConnectors=&gt;[], badLonePairNodes=&gt;[], badFormalChargeNodes=&gt;[]);</div>
<div class="line">    </div>
<div class="line"><span class="preprocessor">    # if (undef $node &amp;&amp; undef $atom){</span></div>
<div class="line"><span class="preprocessor">    #   return true;</span></div>
<div class="line"><span class="preprocessor">    # }</span></div>
<div class="line"><span class="preprocessor">    # if ($node == null || $atom == null){</span></div>
<div class="line"><span class="preprocessor">    #   return false;</span></div>
<div class="line"><span class="preprocessor">    # }</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">    # make sure nodes are the same atom</span></div>
<div class="line"><span class="preprocessor">    # warn &#39;atom&#39;;</span></div>
<div class="line"><span class="preprocessor">    # warn %$atom;</span></div>
<div class="line">    <span class="keywordflow">if</span> ($node-&gt;{isotopeId} ne $Chemical::Chemical::elements[$atom-&gt;{atomNum} - 1]){</div>
<div class="line"><span class="preprocessor">        # warn &quot;NOT SAME ATOMS&quot;;</span></div>
<div class="line"><span class="preprocessor">        # # warn %$node;</span></div>
<div class="line"><span class="preprocessor">        # warn $node-&gt;{isotopeId};</span></div>
<div class="line"><span class="preprocessor">        # # warn %$atom;</span></div>
<div class="line"><span class="preprocessor">        # warn $Chemical::Chemical::elements[$atom-&gt;{atomNum} - 1];</span></div>
<div class="line">        $success{atomsCorrect} = 0;</div>
<div class="line">        <span class="keywordflow">return</span> \%success;</div>
<div class="line">    } <span class="keywordflow">else</span> {</div>
<div class="line"><span class="preprocessor">        # warn $node-&gt;{isotopeId};</span></div>
<div class="line"><span class="preprocessor">        # warn $Chemical::Chemical::elements[$atom-&gt;{atomNum} - 1];</span></div>
<div class="line"><span class="preprocessor">        # #$success{atomsCorrect} = 1;</span></div>
<div class="line"><span class="preprocessor">        # warn &#39;OK THESE ARE MATCHING ATOMS&#39;;</span></div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">    # count connectors</span></div>
<div class="line">    my @kekuleArray = @{$kekuleCTAB-&gt;{nodes}};</div>
<div class="line">    my @kekuleIndexArray = grep { $kekuleArray[$_] == $node } 0 .. $#kekuleArray;</div>
<div class="line"><span class="preprocessor">    # warn @kekuleIndexArray;</span></div>
<div class="line">    my $kekuleIndex = -1;</div>
<div class="line">    <span class="keywordflow">if</span> (scalar @kekuleIndexArray &gt; 0){</div>
<div class="line">        $kekuleIndex = $kekuleIndexArray[0];</div>
<div class="line">    }</div>
<div class="line"><span class="preprocessor">    #  warn &#39;kekule index&#39;;</span></div>
<div class="line"><span class="preprocessor">    #  warn $kekuleIndex;</span></div>
<div class="line"><span class="preprocessor">    # for my $tconn (@{$kekuleCTAB-&gt;{connectors}}){</span></div>
<div class="line"><span class="preprocessor">    #   warn %$tconn;</span></div>
<div class="line"><span class="preprocessor">    # }</span></div>
<div class="line">    my @connectors;</div>
<div class="line">    map {</div>
<div class="line"><span class="preprocessor">            # warn &quot;checking connector&quot;;</span></div>
<div class="line">            <span class="keywordflow">if</span> (! defined $lastConnector || $_ != $lastConnector){</div>
<div class="line"><span class="preprocessor">                # warn @{$_-&gt;{connectedObjs}};</span></div>
<div class="line">                <span class="keywordflow">if</span> ($_-&gt;{connectedObjs}-&gt;[0] == $kekuleIndex || $_-&gt;{connectedObjs}-&gt;[1] == $kekuleIndex){</div>
<div class="line">                    push(@connectors, $_);</div>
<div class="line">                }</div>
<div class="line">            }</div>
<div class="line">        } @{$kekuleCTAB-&gt;{connectors}};</div>
<div class="line"> </div>
<div class="line">    my @bonds;</div>
<div class="line">    map {</div>
<div class="line">        <span class="keywordflow">if</span> ((! defined $lastBond || $_ != $lastBond) &amp;&amp; ($_-&gt;{1} == $atom || $_-&gt;{2} == $atom)){</div>
<div class="line">            push(@bonds, $_);</div>
<div class="line">        }</div>
<div class="line">    } @{$moleculeHash-&gt;{bonds}};</div>
<div class="line">    </div>
<div class="line"><span class="preprocessor">    # Check for same number of bonds</span></div>
<div class="line">    <span class="keywordflow">if</span> (scalar @connectors != scalar @bonds){</div>
<div class="line">         warn <span class="stringliteral">&quot;NOT SAME NUMBER OF BONDS&quot;</span>;</div>
<div class="line">         warn scalar @connectors;</div>
<div class="line">         warn scalar @bonds;</div>
<div class="line">        $success{atomsCorrect} = 0;</div>
<div class="line">        <span class="keywordflow">return</span> \%success;</div>
<div class="line">    } <span class="keywordflow">else</span> {</div>
<div class="line"><span class="preprocessor">        # warn scalar @connectors;</span></div>
<div class="line"><span class="preprocessor">        # warn scalar @bonds;</span></div>
<div class="line"><span class="preprocessor">        # warn &quot;SAME BOND COUNT&quot;;</span></div>
<div class="line"><span class="preprocessor">        #$success{atomsCorrect} = 1;</span></div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    </div>
<div class="line">    </div>
<div class="line"><span class="preprocessor">    # Here&#39;s the meat of the comparison.  We need to verify:</span></div>
<div class="line"><span class="preprocessor">    # 1. correct bond orders</span></div>
<div class="line"><span class="preprocessor">    # 2. correct number of lone pairs</span></div>
<div class="line"><span class="preprocessor">    # 3. correct formal charges</span></div>
<div class="line"><span class="preprocessor">    # 4. XXX perspective bonds are correct XXX  NO, we don&#39;t need this because the drawing app can verify that already.</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">    # For versatility, we might just verify that the basic atoms are connected correctly, but return a hash that tracks not just &quot;match&quot;, </span></div>
<div class="line"><span class="preprocessor">    # but multiple conditions.  Take the &quot;best&quot; result.  i.e. student could draw correct atoms and bonds, but get bond order and lone pairs wrong. </span></div>
<div class="line"><span class="preprocessor">    # So we&#39;ll find a result where connections match but nothing else.</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">    # Checking lonepair counts here</span></div>
<div class="line">    my $nodeLonePairs = 0;</div>
<div class="line">    map {</div>
<div class="line">        <span class="keywordflow">if</span>($_-&gt;{__type__} eq <span class="stringliteral">&quot;Kekule.ChemMarker.UnbondedElectronSet&quot;</span>){</div>
<div class="line">            $nodeLonePairs++;</div>
<div class="line">        }</div>
<div class="line">    } @{$node-&gt;{attachedMarkers}};</div>
<div class="line"><span class="preprocessor">    #warn &quot;LONE PAIRS ON NODE: $nodeLonePairs&quot;;</span></div>
<div class="line"> </div>
<div class="line">    my $atomLonePairs = defined $atom-&gt;{lonePairs} ? $atom-&gt;{lonePairs} : 0;</div>
<div class="line"><span class="preprocessor">    #warn &quot;LONE PAIRS ON ATOM: $atomLonePairs&quot;;</span></div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> ($nodeLonePairs != $atomLonePairs){</div>
<div class="line">        $success{lonePairsCorrect} = 0;</div>
<div class="line"><span class="preprocessor">        #warn &quot;bad lone pair nodes&quot;;</span></div>
<div class="line">        push(@{$success{badLonePairNodes}}, $node);</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">    # Checking charge here</span></div>
<div class="line">    my $nodeFormalCharge =  defined $node-&gt;{charge} ? $node-&gt;{charge} : 0;</div>
<div class="line"><span class="preprocessor">    #warn &quot;Formal Charge ON NODE: $nodeFormalCharge&quot;;</span></div>
<div class="line"> </div>
<div class="line">    my $atomFormalCharge = defined $atom-&gt;{charge} ? $atom-&gt;{charge} : 0;</div>
<div class="line"><span class="preprocessor">    #warn &quot;Formal Charge ON ATOM: $atomFormalCharge&quot;;</span></div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> ($nodeFormalCharge != $atomFormalCharge){</div>
<div class="line">        $success{formalChargesCorrect} = 0;</div>
<div class="line">        push(@{$success{badFormalChargeNodes}}, $node);</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">    # SOMEHOW, NODES ARRAYS ON ANALYSIS AREN&quot;T GETTING COPIED THROUGH TO THE END.  </span></div>
<div class="line">    </div>
<div class="line">    <span class="keywordflow">if</span> (scalar @connectors &gt; 0){</div>
<div class="line"><span class="preprocessor">        # warn &quot;THERE ARE MORE CONNECTORS TO CHECK&quot;;</span></div>
<div class="line"><span class="preprocessor">        # warn scalar @connectors;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">        # warn &quot;CIRCLE&quot;;</span></div>
<div class="line"><span class="preprocessor">        # my $permutations = getCirclePermutations(3);</span></div>
<div class="line"><span class="preprocessor">        # warn @$permutations;</span></div>
<div class="line"><span class="preprocessor">        # for my $test1 (@$permutations){</span></div>
<div class="line"><span class="preprocessor">        #   #warn $test1;</span></div>
<div class="line"><span class="preprocessor">        #   warn @$test1;</span></div>
<div class="line"><span class="preprocessor">        # }</span></div>
<div class="line"><span class="preprocessor">        # warn &quot;PAIRINGS&quot;;</span></div>
<div class="line"><span class="preprocessor">        #generatePairings(\@connectors, \@bonds);</span></div>
<div class="line"> </div>
<div class="line">        %branchSuccess = %success ;#(atomsCorrect=&gt;0, bondOrderCorrect=&gt;0, lonePairsCorrect=&gt;0, formalChargesCorrect=&gt;0,  badConnectors=&gt;[], badLonePairNodes=&gt;[], badFormalChargeNodes=&gt;[]);</div>
<div class="line"><span class="preprocessor">        #%branchSuccess = (atomsCorrect=&gt;0, bondOrderCorrect=&gt;0, lonePairsCorrect=&gt;0, formalChargesCorrect=&gt;0,  badConnectors=&gt;[], badLonePairNodes=&gt;[], badFormalChargeNodes=&gt;[]);</span></div>
<div class="line">        my @temp = (\@connectors, \@bonds);</div>
<div class="line">        my $combinations = <a class="code" href="classChemical_1_1LewisStructure.html#a5370a7da9c11ea9c4ac89066a1331623">generatePairings</a>(\@connectors, \@bonds);</div>
<div class="line"><span class="preprocessor">        # warn &quot;combinations &quot; . scalar @$combinations;</span></div>
<div class="line"><span class="preprocessor">        # warn @$combinations;</span></div>
<div class="line"><span class="preprocessor">        # for my $combo (@$combinations){</span></div>
<div class="line"><span class="preprocessor">        #   warn &quot;combo: &quot; . scalar @$combo;</span></div>
<div class="line"><span class="preprocessor">        #   warn @$combo;</span></div>
<div class="line"><span class="preprocessor">        #   # for my $y (keys %$combo){</span></div>
<div class="line"><span class="preprocessor">        #   #   for my $z (@{$combo-&gt;{$y}}){</span></div>
<div class="line"><span class="preprocessor">        #   #       warn %$z;</span></div>
<div class="line"><span class="preprocessor">        #   #   }</span></div>
<div class="line"><span class="preprocessor">        #   # }</span></div>
<div class="line"><span class="preprocessor">        #   for my $pairT (@$combo){</span></div>
<div class="line"><span class="preprocessor">        #       warn @$pairT;</span></div>
<div class="line"><span class="preprocessor">        #       for my $bondT (@$pairT){</span></div>
<div class="line"><span class="preprocessor">        #           warn %$bondT;</span></div>
<div class="line"><span class="preprocessor">        #       }</span></div>
<div class="line"><span class="preprocessor">        #   }</span></div>
<div class="line"><span class="preprocessor">        # }</span></div>
<div class="line"><span class="preprocessor">        #%branchSuccess = (atomsCorrect=&gt;0, bondOrderCorrect=&gt;0, lonePairsCorrect=&gt;0, formalChargesCorrect=&gt;0,  badConnectors=&gt;[], badLonePairNodes=&gt;[], badFormalChargeNodes=&gt;[]);</span></div>
<div class="line">        </div>
<div class="line">        my @combinationResults = ();</div>
<div class="line">        <span class="keywordflow">for</span> $combo (@$combinations) {</div>
<div class="line"><span class="preprocessor">            #warn &quot;COMBO is&quot;;</span></div>
<div class="line">            </div>
<div class="line"><span class="preprocessor">            # There are several combinations to check.  To &quot;succeed&quot; all pairings inside one combination must match.</span></div>
<div class="line">            my @pairingResults = ();</div>
<div class="line">            <span class="keywordflow">for</span> my $x (@$combo){</div>
<div class="line"> </div>
<div class="line">                my $nextNode = $kekuleArray[$x-&gt;[0]-&gt;{connectedObjs}-&gt;[0]];</div>
<div class="line">                <span class="keywordflow">if</span> ($nextNode == $node){</div>
<div class="line">                    $nextNode = $kekuleArray[$x-&gt;[0]-&gt;{connectedObjs}-&gt;[1]];</div>
<div class="line">                }</div>
<div class="line">                my $nextAtom = $x-&gt;[1]-&gt;{1};</div>
<div class="line">                <span class="keywordflow">if</span> ($nextAtom == $atom){</div>
<div class="line">                    $nextAtom = $x-&gt;[1]-&gt;{2};</div>
<div class="line">                }</div>
<div class="line">                </div>
<div class="line"><span class="preprocessor">                #  warn %$node;</span></div>
<div class="line"><span class="preprocessor">                #  warn &quot;CHECKING COMBINATION:&quot;;</span></div>
<div class="line"><span class="preprocessor">                #  warn %$nextNode;</span></div>
<div class="line"><span class="preprocessor">                #  warn %$nextAtom;</span></div>
<div class="line"><span class="preprocessor">                #my $combinationTest = isIsomorphic($nextNode,$kekuleCTAB, $nextAtom, $moleculeHash, $x-&gt;{$y}-&gt;[0], $x-&gt;{$y}-&gt;[1] );</span></div>
<div class="line">                my $combinationTest = <a class="code" href="classChemical_1_1LewisStructure.html#a8c1b475944b9cc8d04aed09e3292fbf7">isIsomorphic</a>($nextNode,$kekuleCTAB, $nextAtom, $moleculeHash, $x-&gt;[0], $x-&gt;[1] );</div>
<div class="line"><span class="preprocessor">                #  warn &quot;POST COMBINATION TEST&quot;;</span></div>
<div class="line"><span class="preprocessor">                # warn %$combinationTest;</span></div>
<div class="line"><span class="preprocessor">                #warn %{@{$combinationTest-&gt;{badFormalChargeNodes}}[0]};</span></div>
<div class="line">                </div>
<div class="line">                </div>
<div class="line">                my $orderTest = $x-&gt;[0]-&gt;{bondOrder} == $x-&gt;[1]-&gt;{order};</div>
<div class="line"><span class="preprocessor">                # warn &quot;Order was:  $orderTest&quot;;</span></div>
<div class="line"><span class="preprocessor">                #Store bad order node regardless</span></div>
<div class="line">                <span class="keywordflow">if</span> (!$orderTest){</div>
<div class="line"><span class="preprocessor">                    # push(@{$combinationTest-&gt;{badConnectors}},$x-&gt;{$y}-&gt;[0]);</span></div>
<div class="line">                    push(@{$combinationTest-&gt;{badConnectors}},$x-&gt;[0]);</div>
<div class="line"><span class="preprocessor">                    # If recursive order tests return good order, ONLY change it to bad if this order test failed</span></div>
<div class="line">                    $combinationTest-&gt;{bondOrderCorrect} = $orderTest;</div>
<div class="line">                }</div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">                # warn &quot;POST ORDER EDITED&quot;;</span></div>
<div class="line"><span class="preprocessor">                # warn %$combinationTest;</span></div>
<div class="line"><span class="preprocessor">                # warn &quot;COMBINATION RESULTS&quot;;</span></div>
<div class="line"><span class="preprocessor">                # warn $combinationTest;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">                # only add pairing result if atoms are correct</span></div>
<div class="line"><span class="preprocessor">                #if ($combinationTest-&gt;{atomsCorrect}){</span></div>
<div class="line">                    push(@pairingResults, $combinationTest);</div>
<div class="line"><span class="preprocessor">                #}</span></div>
<div class="line"><span class="preprocessor">                # if ($combinationTest-&gt;{lonePairsCorrect}*1 + $combinationTest-&gt;{bondOrderCorrect}*2 + $combinationTest-&gt;{atomsCorrect}*3 </span></div>
<div class="line"><span class="preprocessor">                #   &gt; $success{lonePairsCorrect}*1 + $success{bondOrderCorrect}*2 + $success{atomsCorrect}*3 ){</span></div>
<div class="line"><span class="preprocessor">                #   %success= %$combinationTest;</span></div>
<div class="line"><span class="preprocessor">                # }</span></div>
<div class="line"><span class="preprocessor">                # warn &quot;kekule&quot;;</span></div>
<div class="line"><span class="preprocessor">                # warn %{$x-&gt;{$y}-&gt;[0]};</span></div>
<div class="line"><span class="preprocessor">                # warn &quot;custom&quot;;</span></div>
<div class="line"><span class="preprocessor">                # warn %{$x-&gt;{$y}-&gt;[1]};</span></div>
<div class="line"><span class="preprocessor">                # for my $z (@{$x-&gt;{$y}}){</span></div>
<div class="line"><span class="preprocessor">                #   warn %$z;</span></div>
<div class="line"><span class="preprocessor">                # }</span></div>
<div class="line">            }</div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">            # my $atomsCorrect = $pairingResults[0]{atomsCorrect};</span></div>
<div class="line"><span class="preprocessor">            # my $bondOrderCorrect = $pairingResults[0]{bondOrderCorrect};</span></div>
<div class="line"><span class="preprocessor">            # my $lonePairsCorrect = $pairingResults[0]{lonePairsCorrect};</span></div>
<div class="line">            my %successPairing = (atomsCorrect=&gt;1, bondOrderCorrect=&gt;1, lonePairsCorrect=&gt;1, formalChargesCorrect=&gt;1,  badConnectors=&gt;[], badLonePairNodes=&gt;[], badFormalChargeNodes=&gt;[]);</div>
<div class="line">        </div>
<div class="line"><span class="preprocessor">            # my %successPairing = (</span></div>
<div class="line"><span class="preprocessor">            #   atomsCorrect=&gt;1, </span></div>
<div class="line"><span class="preprocessor">            #   bondOrderCorrect=&gt;1, </span></div>
<div class="line"><span class="preprocessor">            #   formalChargesCorrect=&gt;1,</span></div>
<div class="line"><span class="preprocessor">            #   lonePairsCorrect=&gt;1, </span></div>
<div class="line"><span class="preprocessor">            #   badConnectors=&gt;[], </span></div>
<div class="line"><span class="preprocessor">            #   badLonePairNodes=&gt;[], </span></div>
<div class="line"><span class="preprocessor">            #   badFormalChargeNodes=&gt;[]</span></div>
<div class="line"><span class="preprocessor">            #   );</span></div>
<div class="line"><span class="preprocessor">            # warn &quot;BEFORE SORTING PAIRING RESULTS&quot;;</span></div>
<div class="line"><span class="preprocessor">            # warn scalar @pairingResults;</span></div>
<div class="line">            my $trashPairings = 0;</div>
<div class="line"><span class="preprocessor">            # for my $pairing (@pairingResults){</span></div>
<div class="line"><span class="preprocessor">            #   warn &quot;CHECK&quot;;</span></div>
<div class="line"><span class="preprocessor">            #   if (!$pairing-&gt;{atomsCorrect}){</span></div>
<div class="line"><span class="preprocessor">            #       warn &quot;BAD&quot;;</span></div>
<div class="line"><span class="preprocessor">            #       next;</span></div>
<div class="line"><span class="preprocessor">            #   } </span></div>
<div class="line"><span class="preprocessor">            #   if (!$successPairing{atomsCorrect}){</span></div>
<div class="line"><span class="preprocessor">            #       warn &quot;GOOD!&quot;;</span></div>
<div class="line"><span class="preprocessor">            #       $successPairing{atomsCorrect} = 1;</span></div>
<div class="line"><span class="preprocessor">            #   }</span></div>
<div class="line"><span class="preprocessor">            #   if ($pairing-&gt;{formalChargesCorrect}*1 + $pairing-&gt;{lonePairsCorrect}*2 + $pairing-&gt;{bondOrderCorrect}*3 + $pairing-&gt;{atomsCorrect}*4 </span></div>
<div class="line"><span class="preprocessor">            #           &gt;= $successPairing{formalChargesCorrect}*1 + $successPairing{lonePairsCorrect}*2 + $successPairing{bondOrderCorrect}*3 + $successPairing{atomsCorrect}*4){</span></div>
<div class="line"><span class="preprocessor">            #       %successPairing = %$pairing;</span></div>
<div class="line"><span class="preprocessor">            #       warn &quot;REPLACED SUCCESS PAIRING&quot;;</span></div>
<div class="line"><span class="preprocessor">            #   }       </span></div>
<div class="line"><span class="preprocessor">            # }</span></div>
<div class="line">            map {</div>
<div class="line">                <span class="keywordflow">if</span> ($_-&gt;{atomsCorrect}==0){</div>
<div class="line">                    $successPairing{atomsCorrect} = 0;</div>
<div class="line">                } </div>
<div class="line">                <span class="keywordflow">if</span> ($_-&gt;{bondOrderCorrect}==0){</div>
<div class="line">                    $successPairing{bondOrderCorrect} = 0;</div>
<div class="line">                } </div>
<div class="line">                <span class="keywordflow">if</span> ($_-&gt;{formalChargesCorrect}==0){</div>
<div class="line">                    $successPairing{formalChargesCorrect} = 0;</div>
<div class="line">                } </div>
<div class="line">                <span class="keywordflow">if</span> ($_-&gt;{lonePairsCorrect}==0){</div>
<div class="line">                    $successPairing{lonePairsCorrect} = 0;</div>
<div class="line">                } </div>
<div class="line">                <span class="keywordflow">if</span> ($_-&gt;{badConnectors}){</div>
<div class="line">                    my @tempArray = (@{$successPairing{badConnectors}}, @{$_-&gt;{badConnectors}});</div>
<div class="line">                    $successPairing{badConnectors} = \@tempArray;</div>
<div class="line">                }</div>
<div class="line">                <span class="keywordflow">if</span> ($_-&gt;{badLonePairNodes}){</div>
<div class="line">                    my @tempArray = (@{$successPairing{badLonePairNodes}}, @{$_-&gt;{badLonePairNodes}});</div>
<div class="line">                    $successPairing{badLonePairNodes} = \@tempArray;</div>
<div class="line">                }</div>
<div class="line">                <span class="keywordflow">if</span> ($_-&gt;{badFormalChargeNodes}){</div>
<div class="line">                    my @tempArray = (@{$successPairing{badFormalChargeNodes}}, @{$_-&gt;{badFormalChargeNodes}});                  </div>
<div class="line">                    $successPairing{badFormalChargeNodes} = \@tempArray;</div>
<div class="line">                }</div>
<div class="line">            } @pairingResults;</div>
<div class="line"><span class="preprocessor">            #warn &quot;WERE ATOMS CORRECT AT ALL IN SET?&quot;;</span></div>
<div class="line"><span class="preprocessor">            #warn $successPairing{atomsCorrect};</span></div>
<div class="line">            <span class="keywordflow">if</span> ($successPairing{atomsCorrect}){</div>
<div class="line"><span class="preprocessor">                #warn &quot;SUCCESSFUL PAIRING (i.e. node with atom)&quot;;</span></div>
<div class="line"><span class="preprocessor">                #warn %successPairing;</span></div>
<div class="line">                push(@combinationResults, \%successPairing);</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line"><span class="preprocessor">        # warn &quot;TEST COMBO RESULTS&quot;;</span></div>
<div class="line"><span class="preprocessor">        # warn scalar @combinationResults;</span></div>
<div class="line"><span class="preprocessor">        # for my $comboResult(@combinationResults){</span></div>
<div class="line"><span class="preprocessor">        #   warn %$comboResult;</span></div>
<div class="line"><span class="preprocessor">        #   warn scalar @{$comboResult-&gt;{badFormalChargeNodes}};</span></div>
<div class="line"><span class="preprocessor">        # }</span></div>
<div class="line"><span class="preprocessor">        #warn &quot;ALL COMBINATION RESULTS&quot;;</span></div>
<div class="line"><span class="preprocessor">        #warn scalar @combinationResults;</span></div>
<div class="line">        <span class="keywordflow">if</span> (scalar @combinationResults &gt; 0){</div>
<div class="line">            my %bestOne = (atomsCorrect=&gt;0, bondOrderCorrect=&gt;0, lonePairsCorrect=&gt;0, formalChargesCorrect=&gt;0,  badConnectors=&gt;[], badLonePairNodes=&gt;[], badFormalChargeNodes=&gt;[]);</div>
<div class="line">            map {</div>
<div class="line"><span class="preprocessor">                # THIS MAY NOT WORK AS INTENDED.  DEFINITELY AN AREA TO CHECK IF FURTHER BUGS ARE FOUND.</span></div>
<div class="line"><span class="preprocessor">                # Simple algorithm to rank correctness of model</span></div>
<div class="line">                <span class="keywordflow">if</span> ($_-&gt;{formalChargesCorrect}*1 + $_-&gt;{lonePairsCorrect}*2 + $_-&gt;{bondOrderCorrect}*3 + $_-&gt;{atomsCorrect}*4 </div>
<div class="line">                        &gt;= $bestOne{formalChargesCorrect}*1 + $bestOne{lonePairsCorrect}*2 + $bestOne{bondOrderCorrect}*3 + $bestOne{atomsCorrect}*4){</div>
<div class="line">                    %bestOne = %$_;</div>
<div class="line"><span class="preprocessor">                    #warn &quot;REPLACED BEST ONE SUCCESS&quot;;</span></div>
<div class="line">                }           </div>
<div class="line">            } @combinationResults;</div>
<div class="line">            <span class="keywordflow">if</span> ($bestOne{atomsCorrect}==0){</div>
<div class="line">                $branchSuccess{atomsCorrect} = 0;</div>
<div class="line">            } </div>
<div class="line">            <span class="keywordflow">if</span> ($bestOne{bondOrderCorrect}==0){</div>
<div class="line">                $branchSuccess{bondOrderCorrect} = 0;</div>
<div class="line">            } </div>
<div class="line">            <span class="keywordflow">if</span> ($bestOne{formalChargesCorrect}==0){</div>
<div class="line">                $branchSuccess{formalChargesCorrect} = 0;</div>
<div class="line">            } </div>
<div class="line">            <span class="keywordflow">if</span> ($bestOne{lonePairsCorrect}==0){</div>
<div class="line">                $branchSuccess{lonePairsCorrect} = 0;</div>
<div class="line">            } </div>
<div class="line">            <span class="keywordflow">if</span> ($bestOne{badConnectors}){</div>
<div class="line">                my @tempArray = (@{$branchSuccess{badConnectors}}, @{$bestOne{badConnectors}});</div>
<div class="line">                $branchSuccess{badConnectors} = \@tempArray;</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">if</span> ($bestOne{badLonePairNodes}){</div>
<div class="line">                my @tempArray = (@{$branchSuccess{badLonePairNodes}}, @{$bestOne{badLonePairNodes}});</div>
<div class="line">                $branchSuccess{badLonePairNodes} = \@tempArray;</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">if</span> ($bestOne{badFormalChargeNodes}){</div>
<div class="line">                my @tempArray = (@{$branchSuccess{badFormalChargeNodes}}, @{$bestOne{badFormalChargeNodes}});                   </div>
<div class="line">                $branchSuccess{badFormalChargeNodes} = \@tempArray;</div>
<div class="line">            }</div>
<div class="line">        } <span class="keywordflow">else</span> {</div>
<div class="line">            $branchSuccess{atomsCorrect} = 0;</div>
<div class="line">        }</div>
<div class="line"><span class="preprocessor">        #warn &quot;Branch Success&quot;;</span></div>
<div class="line"><span class="preprocessor">        # warn scalar @{$branchSuccess{badFormalChargeNodes}};</span></div>
<div class="line"><span class="preprocessor">        #warn %branchSuccess;</span></div>
<div class="line"><span class="preprocessor">        #warn scalar @{$branchSuccess{badFormalChargeNodes}};</span></div>
<div class="line"><span class="preprocessor">        #warn &quot;NODES&quot;;</span></div>
<div class="line">        <span class="keywordflow">return</span> \%branchSuccess;</div>
<div class="line">    } <span class="keywordflow">else</span> {</div>
<div class="line"><span class="preprocessor">        #warn &quot;NO MORE CONNECTORS&quot;;</span></div>
<div class="line"><span class="preprocessor">        #warn %success;     </span></div>
<div class="line">        </div>
<div class="line">        <span class="keywordflow">return</span> \%success;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">    #return \%success;</span></div>
<div class="line"><span class="preprocessor">}</span></div>
</div><!-- fragment -->
</div>
 
</div>
</div>
<hr/>The documentation for this class was generated from the following file:<ul>
<li><a class="el" href="contextChemical_8pl_source.html">contextChemical.pl</a></li>
</ul>
</div><!-- contents -->
</div><!-- doc-content -->
<div class="ttc" id="aclassChemical_1_1LewisStructure_html_a775dcc845d2b941771bd7b9e91d69a55"><div class="ttname"><a href="classChemical_1_1LewisStructure.html#a775dcc845d2b941771bd7b9e91d69a55">Chemical::LewisStructure::generateHashFromLaTeXFormula</a></div><div class="ttdeci">public method generateHashFromLaTeXFormula()</div></div>
<div class="ttc" id="aclassChemical_1_1LewisStructure_html_aed2ea23f782b440539a2de14f8c740fb"><div class="ttname"><a href="classChemical_1_1LewisStructure.html#aed2ea23f782b440539a2de14f8c740fb">Chemical::LewisStructure::hashToMolFile</a></div><div class="ttdeci">public method hashToMolFile()</div></div>
<div class="ttc" id="aclassChemical_1_1LewisStructure_html_a6a5c508d640cb21907bfe2e0064b95be"><div class="ttname"><a href="classChemical_1_1LewisStructure.html#a6a5c508d640cb21907bfe2e0064b95be">Chemical::LewisStructure::compareKekuleCTABAndHash</a></div><div class="ttdeci">public method compareKekuleCTABAndHash()</div></div>
<div class="ttc" id="aclassChemical_1_1LewisStructure_html_a5370a7da9c11ea9c4ac89066a1331623"><div class="ttname"><a href="classChemical_1_1LewisStructure.html#a5370a7da9c11ea9c4ac89066a1331623">Chemical::LewisStructure::generatePairings</a></div><div class="ttdeci">public method generatePairings()</div></div>
<div class="ttc" id="aclassChemical_1_1Chemical_html_a9b1f8253632a9b700455a0fced4d7ead"><div class="ttname"><a href="classChemical_1_1Chemical.html#a9b1f8253632a9b700455a0fced4d7ead">Chemical::Chemical::parseValue</a></div><div class="ttdeci">public method parseValue()</div></div>
<div class="ttc" id="aclassChemical_1_1LewisStructure_html_a438ecef1f56d8ea4636ff99a8389032b"><div class="ttname"><a href="classChemical_1_1LewisStructure.html#a438ecef1f56d8ea4636ff99a8389032b">Chemical::LewisStructure::copyMoleculeHash</a></div><div class="ttdeci">public method copyMoleculeHash()</div></div>
<div class="ttc" id="aclassChemical_1_1LewisStructure_html_aab646cd0115094b00da2da4fe7ca40f2"><div class="ttname"><a href="classChemical_1_1LewisStructure.html#aab646cd0115094b00da2da4fe7ca40f2">Chemical::LewisStructure::getCirclePermutations</a></div><div class="ttdeci">public method getCirclePermutations()</div></div>
<div class="ttc" id="aclassChemical_1_1LewisStructure_html_a8c1b475944b9cc8d04aed09e3292fbf7"><div class="ttname"><a href="classChemical_1_1LewisStructure.html#a8c1b475944b9cc8d04aed09e3292fbf7">Chemical::LewisStructure::isIsomorphic</a></div><div class="ttdeci">public method isIsomorphic()</div></div>
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="classChemical.html">Chemical</a></li><li class="navelem"><a class="el" href="classChemical_1_1LewisStructure.html">LewisStructure</a></li>
    <li class="footer">Generated on Wed Aug 2 2023 08:40:31 for WeBWorKChemistry by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.17 </li>
  </ul>
</div>
</body>
</html>
